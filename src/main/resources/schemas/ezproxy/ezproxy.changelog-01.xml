<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--

    Copyright 2010 Trustees of the University of Pennsylvania Licensed under the
    Educational Community License, Version 2.0 (the "License"); you may
    not use this file except in compliance with the License. You may
    obtain a copy of the License at

    http://www.osedu.org/licenses/ECL-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an "AS IS"
    BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
    or implied. See the License for the specific language governing
    permissions and limitations under the License.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="pkeavney" id="ezproxy-01" context="ezproxy_base" dbms="mysql,h2">
        <comment>generate ezproxy-specific database objects</comment>

        <createTable tableName="ezproxy_loading">
            <column autoIncrement="true" name="ez_loading_key" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="patron_ip" type="VARCHAR(32)" remarks="ip address associated with the session"/>
            <column name="patron_ip_key" type="BINARY(16)" remarks="primary key(patron_ip) for patron_ip"/>
            <column name="city" type="VARCHAR(32)" remarks="specific location of the user"/>
            <column name="state" type="VARCHAR(32)" remarks="more general location of the user"/>
            <column name="country" type="VARCHAR(32)" remarks="session's country of origin"/>
            <column name="patron_address_key" type="BINARY(16)"
                    remarks="primary key(city, state, country) for ez_patron_address"/>
            <column name="patron_id" type="VARCHAR(32)" remarks="ezproxy user"/>
            <column name="patron_id_key" type="BINARY(16)" remarks="primary key(patron_id) for ez_patron_id"/>
            <column name="proxy_time" type="DATETIME" remarks="time exproxy query occurred"/>
            <column name="http_method" type="VARCHAR(12)" remarks="[GET,POST, etc]"/>
            <column name="url" type="VARCHAR(2000)" remarks="resource link identifier or site accessed"/>
            <column name="url_key" type="BINARY(16)" remarks="primary key(url) for ez_resources"/>
            <column name="http_status" type="INT" remarks="the status code associated with the query"/>
            <column name="response_size" type="INT" remarks="size of the response returned from the site"/>
            <column name="response_key" type="BINARY(16)"
                    remarks="primary key(http_method, http_status, response_size) for ez_response"/>
            <column name="ref_url" type="VARCHAR(2000)" remarks="The resource link source site or identifier"/>
            <column name="ref_url_key" type="BINARY(16)" remarks="primary key(ref_url) for ez_resources"/>
            <column name="agent" type="VARCHAR(1024)" remarks="the browser or method used to access the resource"/>
            <column name="agent_key" type="BINARY(16)" remarks="primary key(agent) for ez_agent"/>
            <column name="cookies" type="TEXT" remarks="extraneous information associated with the url"/>
            <column name="cookies_key" type="BINARY(16)" remarks="primary key(cookies) for ez_cookies"/>
            <column name="source_file" type="VARCHAR(32)" remarks="the name of the ezproxy file">
                <constraints nullable="false"/>
            </column>
            <column name="source_file_key" type="BINARY(16)" remarks="the primary key(source_file) for ez_source_file"/>
            <column name="line_num" type="INT" remarks="the line within the ezproxy file">
                <constraints nullable="false"/>
            </column>
            <column name="master_key" type="BINARY(16)" remarks="the primary key(source_file, line_num) for ez_master"/>
            <column name="ezproxy_id" type="VARCHAR(35)" remarks="the unique identifier assigned to the session"/>
            <column name="ezproxy_id_key" type="BINARY(16)" remarks="the key for ezproxy_id"/>
            <column defaultValueComputed="CURRENT_TIMESTAMP" name="load_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <createTable tableName="ez_master">
            <column name="master_key" type="BINARY(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="source_file_key" type="BINARY(16)" remarks="the primary key(source_file) for ez_source_file"/>
            <column name="ref_url_key" type="BINARY(16)" remarks="primary key(ref_url) for ez_resources"/>
            <column name="ezproxy_id_key" type="BINARY(16)" remarks="the key for ezproxy_id"/>
            <column name="url_key" type="BINARY(16)" remarks="primary key(url) for ez_resources"/>
            <column name="proxy_time" type="DATETIME" remarks="time exproxy query occurred"/>
            <column name="patron_ip_key" type="BINARY(16)" remarks="primary key(patron_ip) for patron_ip"/>
            <column name="patron_address_key" type="BINARY(16)"
                    remarks="primary key(city, state, country) for ez_patron_address"/>
            <column name="patron_id_key" type="BINARY(16)" remarks="primary key(patron_id) for ez_patron_id"/>
            <column name="response_key" type="BINARY(16)"
                    remarks="primary key(http_method, response_code, response_size) for ez_response"/>
            <column name="agent_key" type="BINARY(16)" remarks="primary key(agent) for ez_agent"/>
            <column name="line_num" type="INT" remarks="the line within the ezproxy file">
                <constraints nullable="false"/>
            </column>
            <column name="load_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="ez_patron_ip">
            <column name="patron_ip" type="VARCHAR(32)" remarks="ip address associated with the session"/>
            <column name="patron_ip_key" type="BINARY(16)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_patron_address">
            <column name="city" type="VARCHAR(32)" remarks="specific location of the user"/>
            <column name="state" type="VARCHAR(32)" remarks="more general location of the user"/>
            <column name="country" type="VARCHAR(32)" remarks="session's country of origin"/>
            <column name="patron_address_key" type="BINARY(16)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_patron_id">
            <column name="patron_id" type="VARCHAR(32)" remarks="ezproxy user"/>
            <column name="patron_id_key" type="BINARY(16)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_response">
            <column name="http_method" type="VARCHAR(12)" remarks="[GET,POST, etc]"/>
            <column name="http_status" type="INT" remarks="the status code associated with the query"/>
            <column name="response_size" type="INT" remarks="size of the response returned from the site"/>
            <column name="response_key" type="BINARY(16)"
                    remarks="primary key(http_method, response_code, response_size)">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_agent">
            <column name="agent" type="VARCHAR(1024)" remarks="the browser or method used to access the resource"/>
            <column name="agent_key" type="BINARY(16)" remarks="primary key(agent) for ez_agent">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_cookies">
            <column name="cookies" type="TEXT" remarks="extraneous information associated with the url"/>
            <column name="cookies_key" type="BINARY(16)" remarks="primary key(cookies) for ez_cookies">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_source_file">
            <column name="source_file" type="VARCHAR(32)" remarks="the name of the ezproxy file">
                <constraints nullable="false"/>
            </column>
            <column name="source_file_key" type="BINARY(16)" remarks="primary key(source_file) for ez_source_file">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_ezproxy_id">
            <column name="ezproxy_id" type="VARCHAR(35)" remarks="the unique identifier assigned to the session"/>
            <column name="ezproxy_id_key" type="BINARY(16)" remarks="primary key(ezproxy_id) for ez_ezproxy_id">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="ez_resources">
            <column name="url" type="VARCHAR(2000)" remarks="resource link identifier or site accessed"/>
            <column name="url_key" type="BINARY(16)" remarks="primary key(url) for ez_resources">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="pmid_resources">
            <column name="url_key" type="BINARY(16)" remarks="primary key(url) for ez_resources">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="doi_resources">
            <column name="url_key" type="BINARY(16)" remarks="primary key(url) for ez_resources">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <createTable tableName="sfx_resources">
            <column name="url_key" type="BINARY(16)" remarks="primary key(url) for ez_resources">
                <constraints primaryKey="true"/>
            </column>
        </createTable>

        <modifySql dbms="mysql">
            <append value=" engine myisam DEFAULT CHARSET=utf8"/>
        </modifySql>
    </changeSet>
    <changeSet id="ezproxy_02" author="Tommy Barker">
        <comment>changing the names of the url tables</comment>
        <renameTable oldTableName="pmid_resources" newTableName="ez_pmid_resources"/>
        <renameTable oldTableName="sfx_resources" newTableName="ez_sfx_resources"/>
        <renameTable oldTableName="doi_resources" newTableName="ez_doi_resources"/>
    </changeSet>

    <changeSet id="ezproxy_03" author="Tommy Barker">
        <createIndex tableName="ez_master" indexName="source_file_key_idx">
            <column name="source_file_key"/>
        </createIndex>
        <createIndex tableName="ez_master" indexName="ref_url_key_idx">
            <column name="ref_url_key"/>
        </createIndex>
        <createIndex tableName="ez_master" indexName="ezproxy_id_key_idx">
            <column name="ezproxy_id_key"/>
        </createIndex>
        <createIndex tableName="ez_master" indexName="url_key_idx">
            <column name="url_key"/>
        </createIndex>
        <createIndex tableName="ez_master" indexName="proxy_time_idx">
            <column name="proxy_time"/>
        </createIndex>
        <createIndex tableName="ez_master" indexName="patron_id_key_idx">
            <column name="patron_id_key"/>
        </createIndex>
        <createIndex tableName="ez_master" indexName="response_key_idx">
            <column name="response_key"/>
        </createIndex>
        <createIndex tableName="ez_master" indexName="agent_key_idx">
            <column name="agent_key"/>
        </createIndex>
    </changeSet>

    <changeSet id="ezproxy_04" author="Tommy Barker">
        <comment>adding the cookie id to the master table</comment>
        <addColumn tableName="ez_master">
            <column name="cookies_key" type="BINARY(16)" remarks="primary key(cookies) for ez_cookies"/>
        </addColumn>
        <createIndex tableName="ez_master" indexName="cookies_key_idx">
            <column name="cookies_key"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>